---
description: General overview of the mgrep project architecture, stack, and core concepts.
globs:
  - "*"
alwaysApply: true
---

# mgrep Project Overview

`mgrep` is a CLI-based semantic search and file indexing tool. It synchronizes local codebases with a vector database (Qdrant) to enable RAG-based question answering and semantic retrieval.

## Core Architecture
- **Provider-based Strategy**: Abstracted interfaces for LLMs, Embeddings, and Web Search (Tavily) allow interchangeable backends.
- **Factory Pattern**: All core services (Store, Providers) MUST be instantiated via the `Context Factory` in `src/lib/context.ts`.
- **Sync-on-Demand**: The system reconciles the local filesystem with the vector store using SHA-256 hashes before search/ask operations.
- **MCP Server**: Implements the Model Context Protocol in `src/commands/watch_mcp.ts` to allow AI agents to use `mgrep` as a tool.

## Technology Stack
- **Runtime**: Node.js with TypeScript.
- **CLI Framework**: `commander.js`.
- **Vector DB**: Qdrant (via `@qdrant/js-client-rest`).
- **Validation**: `zod` for configuration schemas and API contracts.
- **UI**: `@clack/prompts` for interactive terminal experiences.

## Key Concepts
- **Deterministic Point IDs**: Qdrant IDs are generated using `generatePointId(externalId, chunkIndex)` based on file path and chunk index for idempotency.
- **Path Scoping**: Files are indexed with a `path_scopes` array (e.g., `/src/lib/file.ts` -> `['/', '/src', '/src/lib', '/src/lib/file.ts']`) to allow fast hierarchical filtering.
- **Ignore Logic**: Respects both `.gitignore` and `.mgrepignore` using the `ignore` library.
- **Binary Detection**: Uses `istextorbinary` to skip indexing of non-text files.
---
description: Coding standards, factory patterns, and CLI conventions for mgrep.
globs:
  - "src/**/*.ts"
alwaysApply: false
---

# mgrep Code Patterns & Conventions

Follow these patterns to maintain consistency across the `mgrep` codebase.

## Service Instantiation (Factory Pattern)
Never instantiate service classes (like `QdrantStore` or `NodeFileSystem`) directly. Always use the factory functions in `src/lib/context.ts`.

- **DO**: `const store = await createStore();`
- **DON'T**: `const store = new QdrantStore(...);`

## Configuration & Validation
- Use `src/lib/config.ts` for all configuration needs.
- Define new configuration schemas using `zod`.
- Access config via `loadConfig(cwd, options)`.

## CLI Command Structure
Each command should be a standalone module in `src/commands/`.
- Use `commander` to define the command.
- Wrap the action in a `try-catch` block.
- Use `process.exitCode = 1` for errors rather than immediate `process.exit()`.

```typescript
export const myCommand = new Command()
  .name("my-cmd")
  .action(async (options) => {
    try {
      const config = await loadConfig(process.cwd(), options);
      const store = await createStore();
      // Logic here
    } catch (error) {
      console.error(chalk.red(error.message));
      process.exitCode = 1;
    }
  });
```

## File System & Git
- Use `src/lib/file.ts` for file discovery; it respects `.gitignore` and `.mgrepignore`.
- Use `src/lib/git.ts` to interact with the local git repository.

## Logging
- Use the centralized logger in `src/lib/logger.ts`.
- Avoid raw `console.log` in core library files; use the logger to ensure output is captured in the log files at `~/.local/state/mgrep/logs`.
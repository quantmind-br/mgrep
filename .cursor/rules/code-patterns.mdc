---
description: Coding standards, factory patterns, and CLI conventions for mgrep.
globs:
  - "src/**/*.ts"
alwaysApply: false
---

# mgrep Code Patterns & Development Standards

Follow these patterns to maintain consistency and ensure the "Sync-on-Demand" architecture works correctly.

## Service Instantiation (Factory Pattern)
Never instantiate service classes directly. Use the factory functions in `src/lib/context.ts`.
- **DO**: `const store = await createStore();`
- **DON'T**: `const store = new QdrantStore(...);`

## CLI Command Structure
- Define commands in `src/commands/` using `commander`.
- **Error Handling**: Wrap actions in `try-catch`. Use `process.exitCode = 1` for errors.
- **Config**: Always load config via `loadConfig(process.cwd(), options)`.

```typescript
export const myCommand = new Command()
  .name("example")
  .action(async (options) => {
    try {
      const config = await loadConfig(process.cwd(), options);
      const store = await createStore();
      // Implementation
    } catch (error) {
      console.error(chalk.red(error.message));
      process.exitCode = 1;
    }
  });
```

## File System & Syncing
- **Discovery**: Use `src/lib/file.ts`. It respects `.gitignore` and `.mgrepignore` via the `ignore` library.
- **Validation**: Use `istextorbinary` to skip binary files and check `maxFileSize` (default 10MB).
- **Concurrency**: Use `p-limit` (default 20) for parallel file operations during `initialSync`.
- **Hashing**: Use SHA256 hashes to detect changes between local files and the remote store.

## Configuration
- Define all schemas in `src/lib/config.ts` using `zod`.
- Configuration follows a hierarchy: Defaults -> Global YAML -> Local YAML -> Env Vars -> CLI Flags.
